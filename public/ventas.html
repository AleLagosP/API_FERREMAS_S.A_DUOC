<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>Ventas - Ferremas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
        <a class="navbar-brand" href="#">Ferremas</a>
        <div class="navbar-nav">
            <a class="nav-link text-white" href="index.html">Clientes</a>
            <a class="nav-link text-white" href="productos.html">Productos</a>
            <a class="nav-link text-white" href="ventas.html">Ventas</a>
        </div>
        </div>
    </nav>

    <div class="container py-4">
        <h1 class="text-center mb-4">Gestión de Ventas</h1>

        <!-- Formulario -->
        <div class="card mb-4">
        <div class="card-body">
            <form id="ventaForm" class="row g-3">
            <input type="hidden" id="cod_venta" />
            <div class="col-md-3">
                <input type="number" id="id_cliente" class="form-control" placeholder="ID Cliente" required />
            </div>
            <div class="col-md-3">
                <input type="text" id="tipo_entrega" class="form-control" placeholder="Tipo de entrega" required />
            </div>
            <div class="col-md-3">
                <input type="datetime-local" id="fecha_venta" class="form-control" required />
            </div>
            <div class="col-md-3 d-grid gap-2">
                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">Cancelar</button>
            </div>
            </form>
        </div>
        </div>

        <!-- Tabla -->
        <div class="card">
        <div class="card-body">
            <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                <th>ID Venta</th>
                <th>ID Cliente</th>
                <th>Tipo Entrega</th>
                <th>Fecha Venta</th>
                <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaVentas"></tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const API_URL = "http://localhost:5500/api/ventas";

        async function cargarVentas() {
        try {
            const res = await fetch(API_URL);
            const ventas = await res.json();
            const tbody = document.getElementById("tablaVentas");
            tbody.innerHTML = "";

            ventas.forEach(v => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${v.cod_venta}</td>
                <td>${v.id_cliente}</td>
                <td>${v.tipo_entrega}</td>
                <td>${new Date(v.fecha_venta).toLocaleString()}</td>
                <td>
                <button class="btn btn-sm btn-primary me-2" onclick='editarVenta(${JSON.stringify(v)})'>Editar</button>
                <button class="btn btn-sm btn-danger" onclick='eliminarVenta(${v.cod_venta})'>Eliminar</button>
                </td>
            `;
            tbody.appendChild(fila);
            });
        } catch (err) {
            console.error("Error al cargar ventas:", err);
        }
        }

        async function eliminarVenta(id) {
        if (confirm("¿Eliminar esta venta?")) {
            await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            cargarVentas();
        }
        }

        function editarVenta(v) {
        document.getElementById("cod_venta").value = v.cod_venta;
        document.getElementById("id_cliente").value = v.id_cliente;
        document.getElementById("tipo_entrega").value = v.tipo_entrega;
        document.getElementById("fecha_venta").value = new Date(v.fecha_venta).toISOString().slice(0, 16);
        }

        function cancelarEdicion() {
        document.getElementById("ventaForm").reset();
        }

        document.getElementById("ventaForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const cod_venta = document.getElementById("cod_venta").value;
        const datos = {
            id_cliente: document.getElementById("id_cliente").value,
            tipo_entrega: document.getElementById("tipo_entrega").value,
            fecha_venta: document.getElementById("fecha_venta").value
        };

        if (cod_venta) {
            await fetch(`${API_URL}/${cod_venta}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
            });
        } else {
            await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
            });
        }

        document.getElementById("ventaForm").reset();
        cargarVentas();
        });

        cargarVentas();
    </script>

    </body>
</html>